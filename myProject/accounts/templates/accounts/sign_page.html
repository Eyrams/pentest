{% extends "accounts/base.html" %}
{% load static %}

{% block title %}Inscription{% endblock %}



{% block content %}
	<!-- wrapper -->
	<div class="wrapper">
		<!--sidebar-wrapper-->
		<div class="sidebar-wrapper" data-simplebar="true">
			<div class="sidebar-header">
				<div class="">
					<img src="assets/images/logo-icon.png" class="logo-icon-2" alt="" />
				</div>
				<div>
					<h4 class="logo-text">Sign Here</h4>
				</div>
				<a href="javascript:;" class="toggle-btn ml-auto"> <i class="bx bx-menu"></i>
				</a>
			</div>
			<!--navigation-->
			<ul class="metismenu" id="menu">
				<li>
					<a href="javascript:;" class="has-arrow">
						<div class="parent-icon icon-color-1"><i class="bx bx-home-alt"></i>
						</div>
						<div class="menu-title">Dashboard</div>
					</a>
					<ul>
						<li> <a href="index.html"><i class="bx bx-right-arrow-alt"></i>Analytics</a>
						</li>
						<li> <a href="index2.html"><i class="bx bx-right-arrow-alt"></i>Sales</a>
						</li>
					</ul>
				</li>



			<!--end navigation-->
		</div>
		<style>
		body {
			margin: 0;
			padding: 0;
			font-family: Arial, sans-serif;
			font-size: 16px;
			line-height: 1.4;
		}

		#pdfViewer {
			margin-top: 10px;
			text-align: center;
		}

		#pdfViewer canvas {
			max-width: 100%;
			height: auto;
		}

		@media (min-width: 768px) {
			#pdfViewer {
				margin-top: 20px;
			}
		}
	</style>
		<!--end sidebar-wrapper-->
		<!--header-->
		<header class="top-header">
			<nav class="navbar navbar-expand">
				<div class="left-topbar d-flex align-items-center">
					<a href="javascript:;" class="toggle-btn">	<i class="bx bx-menu"></i>
					</a>
				</div>
				<div class="flex-grow-1 search-bar">
					<div class="input-group">
						<div class="input-group-prepend search-arrow-back">
							<button class="btn btn-search-back" type="button"><i class="bx bx-arrow-back"></i>
							</button>
						</div>
						<input type="text" class="form-control" placeholder="search" />
						<div class="input-group-append">
							<button class="btn btn-search" type="button"><i class="lni lni-search-alt"></i>
							</button>
						</div>
					</div>
				</div>
				<div class="right-topbar ml-auto">
					<ul class="navbar-nav">
						<li class="nav-item search-btn-mobile">
							<a class="nav-link position-relative" href="javascript:;">	<i class="bx bx-search vertical-align-middle"></i>
							</a>
						</li>

						</li>
						<li class="nav-item dropdown dropdown-user-profile">
							<a class="nav-link dropdown-toggle dropdown-toggle-nocaret" href="javascript:;" data-toggle="dropdown">
								<div class="media user-box align-items-center">
									<div class="media-body user-info">
										<p class="user-name mb-0">{{request.session.user.first_name}} {{request.session.user.last_name}}</p>
										<p class="designattion mb-0">{{request.session.user.email}}</p>
									</div>
									<img src="{{request.session.user.signature}}" class="user-img" alt="user avatar">
								</div>
							</a>
							<div class="dropdown-menu dropdown-menu-right">	<a class="dropdown-item" href="javascript:;"><i
										class="bx bx-user"></i><span>Profile</span></a>
								<a class="dropdown-item" href="javascript:;"><i
										class="bx bx-cog"></i><span>Settings</span></a>
								<a class="dropdown-item" href="javascript:;"><i
										class="bx bx-tachometer"></i><span>Dashboard</span></a>
								<a class="dropdown-item" href="javascript:;"><i
										class="bx bx-wallet"></i><span>Earnings</span></a>
								<a class="dropdown-item" href="javascript:;"><i
										class="bx bx-cloud-download"></i><span>Downloads</span></a>
								<div class="dropdown-divider mb-0"></div>	<a class="dropdown-item"  href="{% url 'accounts:deconnexion' %}"><i
										class="bx bx-power-off"></i><span>Logout</span></a>
							</div>
						</li>
						<li class="nav-item dropdown dropdown-language">
							<a class="nav-link dropdown-toggle dropdown-toggle-nocaret" href="javascript:;" data-toggle="dropdown">
								<div class="lang d-flex">
									<div><i class="flag-icon flag-icon-um"></i>
									</div>
									<div><span>En</span>
									</div>
								</div>
							</a>
							<div class="dropdown-menu dropdown-menu-right">	<a class="dropdown-item" href="javascript:;"><i
										class="flag-icon flag-icon-de"></i><span>German</span></a>
								<a class="dropdown-item" href="javascript:;"><i
										class="flag-icon flag-icon-fr"></i><span>French</span></a>
								<a class="dropdown-item" href="javascript:;"><i
										class="flag-icon flag-icon-um"></i><span>English</span></a>
								<a class="dropdown-item" href="javascript:;"><i
										class="flag-icon flag-icon-in"></i><span>Hindi</span></a>
								<a class="dropdown-item" href="javascript:;"><i
										class="flag-icon flag-icon-cn"></i><span>Chinese</span></a>
								<a class="dropdown-item" href="javascript:;"><i
										class="flag-icon flag-icon-ae"></i><span>Arabic</span></a>
							</div>
						</li>
					</ul>
				</div>
			</nav>

			<style>
        		body {


        		@media (min-width: 768px) {
        			#box_pdf {
        				margin-top: 20px;
        			}

        		}
        </style>
		</header>
		<!--end header-->



		<!--page-wrapper-->
		<div class="page-wrapper">
			<!--page-content-wrapper-->
			<div class="page-content-wrapper">
				<div class="page-content">
					<!--breadcrumb-->
					<div class="page-breadcrumb d-none d-md-flex align-items-center mb-3">
						<div class="breadcrumb-title pr-3">Timeline</div>
						<div class="pl-3">
							<nav aria-label="breadcrumb">
								<ol class="breadcrumb mb-0 p-0">
									<li class="breadcrumb-item"><a href="javascript:;"><i class='bx bx-home-alt'></i></a>
									</li>
									<li class="breadcrumb-item active" aria-current="page">Timeline</li>
								</ol>
							</nav>
						</div>
						<!-- <div class="ml-auto">
							<div class="btn-group">
								<button type="button" class="btn btn-primary">Settings</button>
								<button type="button" class="btn btn-primary bg-split-primary dropdown-toggle dropdown-toggle-split" data-toggle="dropdown">	<span class="sr-only">Toggle Dropdown</span>
								</button>
								<div class="dropdown-menu dropdown-menu-right dropdown-menu-lg-left">	<a class="dropdown-item" href="javascript:;">Action</a>
									<a class="dropdown-item" href="javascript:;">Another action</a>
									<a class="dropdown-item" href="javascript:;">Something else here</a>
									<div class="dropdown-divider"></div>	<a class="dropdown-item" href="javascript:;">Separated link</a>
								</div>
							</div>
						</div> -->
					</div>
					<!--end breadcrumb-->

					<form method="POST" action="{% url 'webauthin:sign-verify' %}" class="post-form" enctype="multipart/form-data" id ="sign_form" >
						{% csrf_token %}
						<input type="file" id="uploadfile" onchange="previewPdf(event)" name="uploadfile" accept=".pdf">
						<input type="hidden" value="{{request.session.user.national_id_card_number}}" name="username" id="username" >
						<div class="container border" id="div_box_image" style="opacity: 0;">
							<div class="bg-transparent pt-1 text-center">
								<img id="box_image" src="" alt="image"s
										style="max-width: 256px; max-height: 256px;">
							</div>

						</div>


				    	<iframe id ="box_pdf" src="" width="90%" height="1000px"></iframe>
						<div class="btn-group mt-3 w-10">
							<button id="webauthin-sign" type="submit"  class="btn btn-primary btn-block">Signer
							</button>
						</div>
					</form>
					<script>
						function previewPdf(event) {

							var box_pdf = document.getElementById('box_pdf');
							box_pdf.src = window.URL.createObjectURL(event.target.files[0]);
						}


					</script>


					<div class="">
						<div class="">
							<div class="container py-2">
								<h2 class="font-weight-light text-center text-muted py-3">Upload File</h2>
								<!-- timeline item 1 -->
								<div class="row">
									<!-- timeline item 1 left dot -->
									<div class="col-auto text-center flex-column d-none d-sm-flex">
										<div class="row h-50">
											<div class="col">&nbsp;</div>
											<div class="col">&nbsp;</div>
										</div>
										<h5 class="m-2">
											<span class="badge badge-pill bg-primary">&nbsp;</span>
										</h5>
										<div class="row h-50">
											<div class="col border-right">&nbsp;</div>
											<div class="col">&nbsp;</div>
										</div>
									</div>
									<!-- timeline item 1 event content -->
									<div class="col py-2">
										<div class="card radius-15">
											<div class="card-body">
												<!-- <div class="float-right text-muted">Mon, Jan 9th 2020 7:00 AM</div> -->
												<h4 class="card-title text-muted">Etape 1</h4>
												<p class="card-text">Uploader le ficher a signer.</p>
											</div>
										</div>
									</div>
								</div>
								<!--/row-->
								<!-- timeline item 2 -->
								<div class="row">
									<div class="col-auto text-center flex-column d-none d-sm-flex">
										<div class="row h-50">
											<div class="col border-right">&nbsp;</div>
											<div class="col">&nbsp;</div>
										</div>
										<h5 class="m-2">
											<span class="badge badge-pill bg-light border">&nbsp;</span>
										</h5>
										<div class="row h-50">
											<div class="col border-right">&nbsp;</div>
											<div class="col">&nbsp;</div>
										</div>
									</div>
									<div class="col py-2">
										<div class="card border-primary shadow radius-15">
											<div class="card-body">
												<!-- <div class="float-right text-primary">Tue, Jan 10th 2019 8:30 AM</div> -->
												<h4 class="card-title text-primary">Etape 2</h4>
												<p class="card-text">Verifier l'identite du signataire.</p>
												<!-- <button class="btn btn-sm btn-outline-secondary" type="button" data-target="#t2_details" data-toggle="collapse">Show Details ▼</button>
												<div class="collapse border" id="t2_details">
													<div class="p-2 text-monospace">
														<div>08:30 - 09:00 Breakfast in CR 2A</div>
														<div>09:00 - 10:30 Live sessions in CR 3</div>
														<div>10:30 - 10:45 Break</div>
														<div>10:45 - 12:00 Live sessions in CR 3</div>
													</div>
												</div> -->
											</div>
										</div>
									</div>
								</div>
								<!--/row-->
								<!-- timeline item 3 -->
								<div class="row">
									<div class="col-auto text-center flex-column d-none d-sm-flex">
										<div class="row h-50">
											<div class="col border-right">&nbsp;</div>
											<div class="col">&nbsp;</div>
										</div>
										<h5 class="m-2">
                                <span class="badge badge-pill bg-light border">&nbsp;</span>
                            </h5>
										<div class="row h-50">
											<div class="col border-right">&nbsp;</div>
											<div class="col">&nbsp;</div>
										</div>
									</div>
									<div class="col py-2">
										<div class="card radius-15">
											<div class="card-body">

												<h4 class="card-title">Etape 3</h4>
												<p>Telecharger le fichier ou le recevoir par mail.</p>
											</div>
										</div>
									</div>
								</div>
								<!--/row-->
							</div>
							<!--container-->

		</div>
		<!--end page-wrapper-->
		<!--start overlay-->
		<div class="overlay toggle-btn-mobile"></div>
		<!--end overlay-->
		<!--Start Back To Top Button--> <a href="javaScript:;" class="back-to-top"><i class='bx bxs-up-arrow-alt'></i></a>
		<!--End Back To Top Button-->
		<!--footer -->
		<div class="footer">
			<p class="mb-0">SignProject @2020 | Developed By : <a href="#" target="_blank">Norberto</a>
			</p>
		</div>
		<!-- end footer -->
	</div>
	<!-- end wrapper -->
	<!--start switcher-->
	<div class="switcher-wrapper">
		<div class="switcher-btn"> <i class='bx bx-cog bx-spin'></i>
		</div>
		<div class="switcher-body">
			<h5 class="mb-0 text-uppercase">Theme Customizer</h5>
			<hr/>
			<h6 class="mb-0">Theme Styles</h6>
			<hr/>
			<div class="d-flex align-items-center justify-content-between">
				<div class="custom-control custom-radio">
					<input type="radio" id="darkmode" name="customRadio" class="custom-control-input">
					<label class="custom-control-label" for="darkmode">Dark Mode</label>
				</div>
				<div class="custom-control custom-radio">
					<input type="radio" id="lightmode" name="customRadio" checked class="custom-control-input">
					<label class="custom-control-label" for="lightmode">Light Mode</label>
				</div>
			</div>
			<hr/>
			<div class="custom-control custom-switch">
				<input type="checkbox" class="custom-control-input" id="DarkSidebar">
				<label class="custom-control-label" for="DarkSidebar">Dark Sidebar</label>
			</div>
			<hr/>
			<div class="custom-control custom-switch">
				<input type="checkbox" class="custom-control-input" id="ColorLessIcons">
				<label class="custom-control-label" for="ColorLessIcons">Color Less Icons</label>
			</div>
		</div>
	</div>
	<!--end switcher-->
{% endblock%}

{% block scripts%}
	<!-- JavaScript -->
	<!-- jQuery first, then Popper.js, then Bootstrap JS -->
	<script src="assets/js/jquery.min.js"></script>
	<script src="assets/js/popper.min.js"></script>
	<script src="assets/js/bootstrap.min.js"></script>
	<!--plugins-->
	<script src="assets/plugins/simplebar/js/simplebar.min.js"></script>
	<script src="assets/plugins/metismenu/js/metisMenu.min.js"></script>
	<script src="assets/plugins/perfect-scrollbar/js/perfect-scrollbar.js"></script>
	<!-- App JS -->
	<script src="assets/js/app.js"></script>


<script>
    var lookup = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'

    ;(function (exports) {
        'use strict'

        var Arr = (typeof Uint8Array !== 'undefined')
        ? Uint8Array
        : Array

        var PLUS = '+'.charCodeAt(0)
        var SLASH = '/'.charCodeAt(0)
        var NUMBER = '0'.charCodeAt(0)
        var LOWER = 'a'.charCodeAt(0)
        var UPPER = 'A'.charCodeAt(0)
        var PLUS_URL_SAFE = '-'.charCodeAt(0)
        var SLASH_URL_SAFE = '_'.charCodeAt(0)

        function decode (elt) {
            var code = elt.charCodeAt(0)
            if (code === PLUS || code === PLUS_URL_SAFE) return 62 // '+'
            if (code === SLASH || code === SLASH_URL_SAFE) return 63 // '/'
            if (code < NUMBER) return -1 // no match
            if (code < NUMBER + 10) return code - NUMBER + 26 + 26
            if (code < UPPER + 26) return code - UPPER
            if (code < LOWER + 26) return code - LOWER + 26
        }

        function b64ToByteArray (b64) {
            var i, j, l, tmp, placeHolders, arr

            if (b64.length % 4 > 0) {
                throw new Error('Invalid string. Length must be a multiple of 4')
            }

            // the number of equal signs (place holders)
            // if there are two placeholders, than the two characters before it
            // represent one byte
            // if there is only one, then the three characters before it represent 2 bytes
            // this is just a cheap hack to not do indexOf twice
            var len = b64.length
            placeHolders = b64.charAt(len - 2) === '=' ? 2 : b64.charAt(len - 1) === '=' ? 1 : 0

            // base64 is 4/3 + up to two characters of the original data
            arr = new Arr(b64.length * 3 / 4 - placeHolders)

            // if there are placeholders, only get up to the last complete 4 chars
            l = placeHolders > 0 ? b64.length - 4 : b64.length

            var L = 0

            function push (v) {
                arr[L++] = v
            }

            for (i = 0, j = 0; i < l; i += 4, j += 3) {
                tmp = (decode(b64.charAt(i)) << 18) | (decode(b64.charAt(i + 1)) << 12) | (decode(b64.charAt(i + 2)) << 6) | decode(b64.charAt(i + 3))
                push((tmp & 0xFF0000) >> 16)
                push((tmp & 0xFF00) >> 8)
                push(tmp & 0xFF)
            }

            if (placeHolders === 2) {
                tmp = (decode(b64.charAt(i)) << 2) | (decode(b64.charAt(i + 1)) >> 4)
                push(tmp & 0xFF)
                } else if (placeHolders === 1) {
                tmp = (decode(b64.charAt(i)) << 10) | (decode(b64.charAt(i + 1)) << 4) | (decode(b64.charAt(i + 2)) >> 2)
                push((tmp >> 8) & 0xFF)
                push(tmp & 0xFF)
            }

            return arr
        }

        function uint8ToBase64 (uint8) {
            var i
            var extraBytes = uint8.length % 3 // if we have 1 byte left, pad 2 bytes
            var output = ''
            var temp, length

            function encode (num) {
                return lookup.charAt(num)
            }

            function tripletToBase64 (num) {
                return encode(num >> 18 & 0x3F) + encode(num >> 12 & 0x3F) + encode(num >> 6 & 0x3F) + encode(num & 0x3F)
            }

            // go through the array every three bytes, we'll deal with trailing stuff later
            for (i = 0, length = uint8.length - extraBytes; i < length; i += 3) {
                temp = (uint8[i] << 16) + (uint8[i + 1] << 8) + (uint8[i + 2])
                output += tripletToBase64(temp)
            }

            // pad the end with zeros, but make sure to not forget the extra bytes
            switch (extraBytes) {
                case 1:
                temp = uint8[uint8.length - 1]
                output += encode(temp >> 2)
                output += encode((temp << 4) & 0x3F)
                output += '=='
                break
                case 2:
                temp = (uint8[uint8.length - 2] << 8) + (uint8[uint8.length - 1])
                output += encode(temp >> 10)
                output += encode((temp >> 4) & 0x3F)
                output += encode((temp << 2) & 0x3F)
                output += '='
                break
                default:
                break
            }

            return output
        }

        exports.toByteArray = b64ToByteArray
        exports.fromByteArray = uint8ToBase64
    }(typeof exports === 'undefined' ? (this.base64js = {}) : exports))



    function b64enc(buf) {
        return base64js.fromByteArray(buf)
        .replace(/\+/g, "-")
        .replace(/\//g, "_")
        .replace(/=/g, "");
    }

    function b64RawEnc(buf) {
        return base64js.fromByteArray(buf)
        .replace(/\+/g, "-")
        .replace(/\//g, "_");
    }

    function hexEncode(buf) {
        return Array.from(buf)
        .map(function(x) {
            return ("0" + x.toString(16)).substr(-2);
        })
        .join("");
    }

    function urlsafe_b64decode(s) {
        return atob(s.replace(/\-/g, '+').replace(/_/g, '/'));
    }

    async function fetch_json(url, options) {
        const response = await fetch(url, options);
        const body = await response.json();
        if (body.fail)
        throw body.fail;
        return body;
    }



    /**
    * Get PublicKeyCredentialRequestOptions for this user from the server
    * formData of the registration form
    * @param {FormData} formData
    */
    const getCredentialRequestOptionsFromServer = async () => {
        return await fetch_json(
        "{% url "webauthin:sign-begin" %}", {
            method: "POST",
        }
        );
    }

    const transformCredentialRequestOptions = (credentialRequestOptionsFromServer) => {
        let {challenge, allowCredentials} = credentialRequestOptionsFromServer;

        challenge = Uint8Array.from(
        urlsafe_b64decode(challenge), c => c.charCodeAt(0));

        allowCredentials = allowCredentials.map(credentialDescriptor => {
            let {id} = credentialDescriptor;
            id = Uint8Array.from(urlsafe_b64decode(id), c => c.charCodeAt(0));
            return Object.assign({}, credentialDescriptor, {id});
        });

        const transformedCredentialRequestOptions = Object.assign(
        {},
        credentialRequestOptionsFromServer,
        {challenge, allowCredentials});

        return transformedCredentialRequestOptions;
    };


    /**
    * Callback executed after submitting login form
    * @param {Event} e
    */
    const didClickSign = async (e) => {
        e.preventDefault();
        if (navigator.credentials == undefined) {
            alert("Your browser doesn't support WebAuthn, please use a different browser.");
            return;
        }

        let credentialCreateOptionsFromServer;
        try {

            credentialRequestOptionsFromServer = await getCredentialRequestOptionsFromServer();

        } catch (err) {
            return console.error("Error when getting request options from server:", err);
        }
        ;
        const transformedCredentialRequestOptions = transformCredentialRequestOptions(credentialRequestOptionsFromServer);

        let assertion;
        try {

            assertion = await navigator.credentials.get({
                publicKey: transformedCredentialRequestOptions,
            });
        } catch (err) {
            alert("Error when creating credential: " + err);
            return console.error("Error when creating credential: ", err);
        }

        const transformedAssertionForServer = transformAssertionForServer(assertion);

        postAssertionToServer(transformedAssertionForServer);
    };

    /**
    * Encodes the binary data in the assertion into strings for posting to the server.
    * @param {PublicKeyCredential} newAssertion
    */
    const transformAssertionForServer = (newAssertion) => {
        const authData = new Uint8Array(newAssertion.response.authenticatorData);
        const clientDataJSON = new Uint8Array(newAssertion.response.clientDataJSON);
        const rawId = new Uint8Array(newAssertion.rawId);
        const sig = new Uint8Array(newAssertion.response.signature);
        const assertionClientExtensions = newAssertion.getClientExtensionResults();

        return {
            id: newAssertion.id,
            rawId: b64enc(rawId),
            type: newAssertion.type,
            authData: b64RawEnc(authData),
            clientData: b64RawEnc(clientDataJSON),
            signature: hexEncode(sig),
            assertionClientExtensions: JSON.stringify(assertionClientExtensions)
        };
    };

    /**
    * Post the assertion to the server for validation and logging the user in.
    * @param {Object} assertionDataForServer
    */
    const postAssertionToServer = async (assertionDataForServer) => {


        let sign_form = document.getElementById("sign_form");

        Object.entries(assertionDataForServer).forEach(([key, value]) => {
            var element = document.createElement("input");
            element.value=value;
            element.name=key;
            element.type="hidden";
            sign_form.appendChild(element);
        });

        sign_form.submit();



    }


    document.addEventListener("DOMContentLoaded", e => {
        document.querySelector('#webauthin-sign').addEventListener('click', didClickSign);
    });
</script>

{% endblock%}
